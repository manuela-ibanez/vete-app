<div class="container py-4">
  <h2>Listado de Mascotas</h2>

  <!-- TABLA DE MASCOTAS -->
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Clase</th>
        <th>Peso</th>
        <th>Edad</th>
        <th>Dueño</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let mascota of mascotasFiltradas">
        <!-- FILA NORMAL -->
        <tr>
          <td>{{ mascota.id }}</td>
          <td>{{ mascota.nombre }}</td>
          <td>{{ mascota.clase }}</td>
          <td>{{ mascota.peso }} kg</td>
          <td>{{ mascota.edad }} años</td>
          <td>
            {{ mascota.usuario?.nombre || 'Sin dueño' }}
            {{ mascota.usuario?.apellido || '' }}
          </td>
          <td>
            <button class="btn btn-sm btn-warning me-2" (click)="editarMascota(mascota)">
              Editar
            </button>
            <button class="btn btn-sm btn-danger" (click)="deleteMascota(mascota.id!)">
              Eliminar
            </button>
          </td>
        </tr>

        <!-- FILA DEL FORMULARIO DE EDICIÓN -->
        <tr *ngIf="mascotaSeleccionada?.id === mascota.id">
          <td colspan="7">
            <div class="card border-warning">
              <div class="card-body">
                <form (ngSubmit)="actualizarMascota()" #editarForm="ngForm">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Nombre *</label>
                      <input 
                        type="text"
                        [(ngModel)]="mascotaSeleccionada!.nombre"
                        name="nombre"
                        #nombreEdit="ngModel"
                        required
                        minlength="2"
                        maxlength="50"
                        class="form-control"
                        [class.is-invalid]="nombreEdit.invalid && nombreEdit.touched" />
                      <div class="invalid-feedback" *ngIf="nombreEdit.invalid && nombreEdit.touched">
                        <small *ngIf="nombreEdit.errors?.['required']">El nombre es obligatorio</small>
                        <small *ngIf="nombreEdit.errors?.['minlength']">Mínimo 2 caracteres</small>
                        <small *ngIf="nombreEdit.errors?.['maxlength']">Máximo 50 caracteres</small>
                      </div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label">Clase *</label>
                      <input 
                        type="text"
                        [(ngModel)]="mascotaSeleccionada!.clase"
                        name="clase"
                        #claseEdit="ngModel"
                        required
                        minlength="2"
                        maxlength="30"
                        class="form-control"
                        [class.is-invalid]="claseEdit.invalid && claseEdit.touched" />
                      <div class="invalid-feedback" *ngIf="claseEdit.invalid && claseEdit.touched">
                        <small *ngIf="claseEdit.errors?.['required']">La clase es obligatoria</small>
                        <small *ngIf="claseEdit.errors?.['minlength']">Mínimo 2 caracteres</small>
                        <small *ngIf="claseEdit.errors?.['maxlength']">Máximo 30 caracteres</small>
                      </div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label">Peso (kg) *</label>
                      <input 
                        type="number"
                        [(ngModel)]="mascotaSeleccionada!.peso"
                        name="peso"
                        #pesoEdit="ngModel"
                        required
                        min="0.1"
                        max="500"
                        step="0.1"
                        class="form-control"
                        [class.is-invalid]="pesoEdit.invalid && pesoEdit.touched" />
                      <div class="invalid-feedback" *ngIf="pesoEdit.invalid && pesoEdit.touched">
                        <small *ngIf="pesoEdit.errors?.['required']">El peso es obligatorio</small>
                        <small *ngIf="pesoEdit.errors?.['min']">El peso mínimo es 0.1 kg</small>
                        <small *ngIf="pesoEdit.errors?.['max']">El peso máximo es 500 kg</small>
                      </div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label class="form-label">Edad (años) *</label>
                      <input 
                        type="number"
                        [(ngModel)]="mascotaSeleccionada!.edad"
                        name="edad"
                        #edadEdit="ngModel"
                        required
                        min="0"
                        max="50"
                        class="form-control"
                        [class.is-invalid]="edadEdit.invalid && edadEdit.touched" />
                      <div class="invalid-feedback" *ngIf="edadEdit.invalid && edadEdit.touched">
                        <small *ngIf="edadEdit.errors?.['required']">La edad es obligatoria</small>
                        <small *ngIf="edadEdit.errors?.['min']">La edad mínima es 0 años</small>
                        <small *ngIf="edadEdit.errors?.['max']">La edad máxima es 50 años</small>
                      </div>
                    </div>
                  </div>

                  <button type="submit" class="btn btn-success me-2" [disabled]="editarForm.invalid">
                    Actualizar
                  </button>
                  <button 
                    type="button"
                    (click)="mascotaSeleccionada = null"
                    class="btn btn-secondary">
                    Cancelar
                  </button>
                </form>
              </div>
            </div>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <!-- FORMULARIO PARA CREAR NUEVA MASCOTA -->
  <div class="card mt-4">
    <div class="card-header bg-primary text-white">
      <h4>Añadir Nueva Mascota</h4>
    </div>
    <div class="card-body">
      <form (ngSubmit)="onSubmit(MascotasForm)" #MascotasForm="ngForm">
        
        <h5 class="mb-3">Datos de la Mascota</h5>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="nombre" class="form-label">Nombre *</label>
            <input 
              type="text" 
              class="form-control" 
              id="nombre" 
              [(ngModel)]="nombre" 
              name="nombre"
              #nombreInput="ngModel"
              required
              minlength="2"
              maxlength="50"
              [class.is-invalid]="nombreInput.invalid && nombreInput.touched" />
            <div class="invalid-feedback" *ngIf="nombreInput.invalid && nombreInput.touched">
              <small *ngIf="nombreInput.errors?.['required']">El nombre es obligatorio</small>
              <small *ngIf="nombreInput.errors?.['minlength']">Mínimo 2 caracteres</small>
              <small *ngIf="nombreInput.errors?.['maxlength']">Máximo 50 caracteres</small>
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="clase" class="form-label">Clase (Perro, Gato, etc.) *</label>
            <input 
              type="text" 
              class="form-control" 
              id="clase" 
              [(ngModel)]="clase" 
              name="clase"
              #claseInput="ngModel"
              required
              minlength="2"
              maxlength="30"
              [class.is-invalid]="claseInput.invalid && claseInput.touched" />
            <div class="invalid-feedback" *ngIf="claseInput.invalid && claseInput.touched">
              <small *ngIf="claseInput.errors?.['required']">La clase es obligatoria</small>
              <small *ngIf="claseInput.errors?.['minlength']">Mínimo 2 caracteres</small>
              <small *ngIf="claseInput.errors?.['maxlength']">Máximo 30 caracteres</small>
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="peso" class="form-label">Peso (kg) *</label>
            <input 
              type="number" 
              class="form-control" 
              id="peso" 
              [(ngModel)]="peso" 
              name="peso"
              #pesoInput="ngModel"
              required
              min="0.1"
              max="500"
              step="0.1"
              [class.is-invalid]="pesoInput.invalid && pesoInput.touched" />
            <div class="invalid-feedback" *ngIf="pesoInput.invalid && pesoInput.touched">
              <small *ngIf="pesoInput.errors?.['required']">El peso es obligatorio</small>
              <small *ngIf="pesoInput.errors?.['min']">El peso mínimo es 0.1 kg</small>
              <small *ngIf="pesoInput.errors?.['max']">El peso máximo es 500 kg</small>
            </div>
          </div>

          <div class="col-md-6 mb-3">
            <label for="edad" class="form-label">Edad (años) *</label>
            <input 
              type="number" 
              class="form-control" 
              id="edad" 
              [(ngModel)]="edad" 
              name="edad"
              #edadInput="ngModel"
              required
              min="0"
              max="50"
              [class.is-invalid]="edadInput.invalid && edadInput.touched" />
            <div class="invalid-feedback" *ngIf="edadInput.invalid && edadInput.touched">
              <small *ngIf="edadInput.errors?.['required']">La edad es obligatoria</small>
              <small *ngIf="edadInput.errors?.['min']">La edad mínima es 0 años</small>
              <small *ngIf="edadInput.errors?.['max']">La edad máxima es 50 años</small>
            </div>
          </div>

          <div class="col-md-12 mb-3">
            <label for="usuarioId" class="form-label">Dueño *</label>
            <select 
              class="form-control" 
              [(ngModel)]="usuariosId" 
              name="usuarioId" 
              id="usuarioId"
              #usuarioInput="ngModel"
              required
              [class.is-invalid]="usuarioInput.invalid && usuarioInput.touched">
              <option [ngValue]="undefined">Seleccione un usuario</option>
              <option *ngFor="let u of usuarios" [ngValue]="u.id">
                {{ u.nombre }} {{ u.apellido }}
              </option>
            </select>
            <div class="invalid-feedback" *ngIf="usuarioInput.invalid && usuarioInput.touched">
              <small *ngIf="usuarioInput.errors?.['required']">Debes seleccionar un dueño</small>
            </div>
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg" [disabled]="MascotasForm.invalid">
          Añadir Mascota
        </button>
      </form>
    </div>
  </div>
</div>